<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Exam Portal - GP Soldiers Academy</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f9ff;
      margin: 0; padding: 0;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 18px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      position: fixed;
      top: 0; width: 100%;
      z-index: 100;
    }

    .back-btn {
      position: absolute;
      left: 15px; top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .back-btn i { color: white; font-size: 1.2rem; }

    .main {
      margin-top: 90px;
      padding: 20px;
      max-width: 480px;
      margin-left: auto; margin-right: auto;
    }

    .card {
      background: white;
      padding: 22px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    /* Book Loader */
    .book-loader {
      width: 70px;
      height: 70px;
      margin: 40px auto;
      background-image: url('https://i.imgur.com/1a5YgcW.gif');
      background-size: cover;
    }

    /* SUBJECT BOX */
    .subject-box {
      background: #e8f0ff;
      padding: 10px 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 15px;
      border: 1px solid #cfdcff;
    }

    /* QUESTIONS */
    .question-container {
      background: #f8fafc;
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 18px;
    }

    .question-img {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .option {
      display: flex;
      align-items: center;
      background: white;
      border: 2px solid #e2e8f0;
      padding: 14px;
      border-radius: 12px;
      margin: 8px 0;
      cursor: pointer;
    }
    .option:hover { border-color: #2563eb; }

    .option input { margin-right: 12px; transform: scale(1.4); }

    .submit-btn {
      background: #10b981;
      color: white;
      padding: 16px;
      border-radius: 12px;
      border: none;
      width: 100%;
      font-size: 1.2rem;
      margin-top: 15px;
      cursor: pointer;
    }

    /* POPUPS */
    .popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .popup-card {
      background: white;
      padding: 28px;
      border-radius: 16px;
      text-align: center;
      width: 85%;
      max-width: 380px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .popup-card h2 {
      color: #2563eb;
      margin-bottom: 15px;
    }
    .popup-card button {
      margin-top: 15px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>

<header>
  <div class="back-btn" onclick="handleExit()">
    <i class="fas fa-arrow-left"></i>
  </div>
  Student Exam Portal
</header>

<div class="main">

  <!-- EXAM LIST -->
  <div id="examList" class="card">
    <h2 style="text-align:center; color:#2563eb;">Available Exams</h2>
    <div id="examLoader" class="book-loader"></div>
    <div id="examsContainer" class="hidden"></div>
  </div>

  <!-- EXAM TAKING -->
  <div id="examTaking" class="card hidden">
    <h2 id="examTitleDisplay" style="text-align:center; color:#2563eb;"></h2>

    <div id="subjectBox" class="subject-box"></div>

    <form id="examForm">
      <div id="questionsContainer"></div>
      <button class="submit-btn" type="submit">Submit Exam</button>
    </form>
  </div>
</div>

<!-- START WARNING POPUP -->
<div id="startPopup" class="popup">
  <div class="popup-card">
    <h2>Exam Starting</h2>
    <p>Are you ready? Do not exit the exam after starting.</p>
    <button onclick="beginExam()">Start Now</button>
  </div>
</div>

<!-- EXIT WARNING POPUP -->
<div id="exitPopup" class="popup">
  <div class="popup-card">
    <h2>Exit Exam?</h2>
    <p>Your answers are saved. Are you sure you want to leave?</p>
    <button onclick="confirmExit()">Yes, Exit</button>
  </div>
</div>

<!-- SUBMISSION POPUP -->
<div id="resultPopup" class="popup">
  <div class="popup-card">
    <h2 id="popupTitle"></h2>
    <p id="popupMessage"></p>
    <button onclick="closePopup()">OK</button>
  </div>
</div>

<script>
const API_URL = "https://academy-backend-e02j.onrender.com";

let currentExam;
let studentAnswers = [];
let selectedExamId = null;
let examStarted = false;
const STORAGE_KEY = "saved_exam_answers";

/* EXIT WARNING */
window.onbeforeunload = function () {
  if (examStarted) return "Are you sure you want to exit the exam?";
};

/* LOAD EXAMS */
window.onload = loadExams;

async function loadExams() {
  const loader = document.getElementById("examLoader");
  const container = document.getElementById("examsContainer");

  try {
    const res = await fetch(`${API_URL}/active-exams`);
    const exams = await res.json();

    loader.classList.add("hidden");
    container.classList.remove("hidden");

    if (!exams.length) {
      container.innerHTML = "<p style='text-align:center;color:#888;'>No exams now</p>";
      return;
    }

    container.innerHTML = exams.map(ex =>
      `<div onclick="showStartPopup('${ex._id}')"
         style="background:#e8f0ff;padding:18px;border-radius:14px;margin:10px 0;cursor:pointer;">
         <h3 style="color:#2563eb;">${ex.title}</h3>
         <p>${ex.subject?.toUpperCase()} - Test ${ex.testNumber}</p>
       </div>`
    ).join("");

  } catch {
    loader.classList.add("hidden");
    container.innerHTML = "<p style='color:red;text-align:center;'>Failed to load exams</p>";
  }
}

/* START WARNING POPUP */
function showStartPopup(id) {
  selectedExamId = id;
  document.getElementById("startPopup").style.display = "flex";
}

async function beginExam() {
  document.getElementById("startPopup").style.display = "none";
  examStarted = true;
  startExam(selectedExamId);
}

/* START EXAM */
async function startExam(id) {
  try {
    const res = await fetch(`${API_URL}/exam/${id}`);
    currentExam = await res.json();

    document.getElementById("examList").classList.add("hidden");
    document.getElementById("examTaking").classList.remove("hidden");

    document.getElementById("examTitleDisplay").textContent = currentExam.title;

    document.getElementById("subjectBox").textContent =
      `${currentExam.subject.toUpperCase()} â€¢ Test ${currentExam.testNumber}`;

    studentAnswers = new Array(currentExam.totalQuestions).fill(null);

    loadSavedAnswers(id);

    const container = document.getElementById("questionsContainer");
    container.innerHTML = currentExam.questions.map((q, i) => `
      <div class="question-container">
        <img src="${q.imageUrl}" class="question-img">
        ${renderOptions(i)}
      </div>
    `).join("");

    restoreSelectedOptions();

  } catch {
    alert("Error loading exam");
  }
}

/* OPTIONS RENDER */
function renderOptions(i) {
  return `
    ${["a","b","c","d"].map(o => `
      <label class="option">
        <input type="radio" name="q${i}" value="${o}" onchange="saveAnswer(${i},'${o}')">
        <span>${o.toUpperCase()}</span>
      </label>
    `).join("")}
  `;
}

/* SAVE ANSWER TO LOCAL STORAGE */
function saveAnswer(i, val) {
  studentAnswers[i] = val;
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    examId: currentExam._id,
    answers: studentAnswers
  }));
}

/* RESTORE SAVED ANSWERS */
function loadSavedAnswers(examId) {
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (saved && saved.examId === examId) studentAnswers = saved.answers;
}

function restoreSelectedOptions() {
  studentAnswers.forEach((ans, i) => {
    if (ans) {
      document.querySelector(`input[name='q${i}'][value='${ans}']`).checked = true;
    }
  });
}

/* SUBMIT */
document.getElementById("examForm").addEventListener("submit", async e => {
  e.preventDefault();

  try {
    const res = await fetch(`${API_URL}/submit-exam`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        examId: currentExam._id,
        answers: studentAnswers,
        studentName: "Student",
        studentMobile: "0000000000",
        studentRoll: "N/A"
      })
    });

    if (!res.ok) throw new Error();

    examStarted = false;
    localStorage.removeItem(STORAGE_KEY);

    showPopup("SUCCESSFUL", "Your exam has been submitted!");

    loadExams();
    document.getElementById("examTaking").classList.add("hidden");
    document.getElementById("examList").classList.remove("hidden");

  } catch {
    showPopup("FAILED", "Submission failed. Try again.");
  }
});

/* EXIT WARNING MANUALLY */
function handleExit() {
  if (!examStarted) location.href = "index.html";
  else {
    document.getElementById("exitPopup").style.display = "flex";
  }
}

function confirmExit() {
  examStarted = false;
  location.href = "index.html";
}

/* POPUP */
function showPopup(title, msg) {
  document.getElementById("popupTitle").textContent = title;
  document.getElementById("popupMessage").textContent = msg;
  document.getElementById("resultPopup").style.display = "flex";
}

function closePopup() {
  document.getElementById("resultPopup").style.display = "none";
}
</script>

</body>
</html>
