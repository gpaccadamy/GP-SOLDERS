<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Exam Portal - GP Soldiers Academy</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* your existing styles remain the same â€“ no change needed */
    /* ... paste all your previous CSS here ... */
  </style>
</head>
<body>
  <!-- your HTML structure remains the same -->
  <!-- ... paste your HTML here (header, main, popups, etc.) ... -->

<script>
const API_URL = "https://academy-backend-e02j.onrender.com";
let currentExam;
let studentAnswers = [];
let selectedExamId = null;
let examStarted = false;
const STORAGE_KEY = "saved_exam_answers";
const COMPLETED_EXAMS_KEY = "completed_exam_ids_2025"; // changed key name to avoid old data conflict

window.onbeforeunload = function () {
  if (examStarted) return "Are you sure? Your exam progress will be lost.";
};

window.onload = loadExams;

async function loadExams() {
  const loader = document.getElementById("examLoader");
  const container = document.getElementById("examsContainer");
  try {
    const res = await fetch(`${API_URL}/active-exams`);
    if (!res.ok) throw new Error("Failed to fetch exams");
    let exams = await res.json();

    // Get completed IDs
    const completedStr = localStorage.getItem(COMPLETED_EXAMS_KEY);
    const completed = completedStr ? new Set(JSON.parse(completedStr)) : new Set();

    console.log("Completed exams from storage:", Array.from(completed)); // debug

    // Filter out completed
    exams = exams.filter(ex => !completed.has(ex._id));

    loader.classList.add("hidden");
    container.classList.remove("hidden");

    if (exams.length === 0) {
      container.innerHTML = "<p style='text-align:center;color:#888;'>No available exams (you may have completed them)</p>";
      return;
    }

    container.innerHTML = exams.map(ex => `
      <div onclick="showStartPopup('${ex._id}')"
           style="background:#e8f0ff;padding:18px;border-radius:14px;margin:10px 0;cursor:pointer;">
        <h3 style="color:#2563eb;">${ex.title}</h3>
        <p>${ex.subject?.toUpperCase()} - Test ${ex.testNumber}</p>
      </div>
    `).join("");

  } catch (err) {
    console.error("Load exams error:", err);
    loader.classList.add("hidden");
    container.innerHTML = "<p style='color:red;text-align:center;'>Failed to load exams</p>";
  }
}

function markExamCompleted(examId) {
  let completed = JSON.parse(localStorage.getItem(COMPLETED_EXAMS_KEY) || '[]');
  if (!completed.includes(examId)) {
    completed.push(examId);
    localStorage.setItem(COMPLETED_EXAMS_KEY, JSON.stringify(completed));
    console.log("Marked as completed:", examId); // debug
    console.log("Current completed list:", completed);
  }
}

/* ... rest of your functions remain the same ... */

/* In validateAndSubmit(), after successful submission: */
async function validateAndSubmit() {
  // ... your validation code ...

  if (!valid) return;

  document.getElementById("studentInfoPopup").style.display = "none";

  try {
    const res = await fetch(`${API_URL}/submit-exam`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        examId: currentExam._id,
        answers: studentAnswers,
        studentName: name,
        studentMobile: mobile,
        studentRoll: roll
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Submission failed");
    }

    // Mark as completed
    markExamCompleted(currentExam._id);

    examStarted = false;
    localStorage.removeItem(STORAGE_KEY);

    showPopup("SUCCESS", "Exam submitted successfully!");

    // Wait a bit so user sees message, then reload list
    setTimeout(() => {
      document.getElementById("examTaking").classList.add("hidden");
      document.getElementById("examList").classList.remove("hidden");
      loadExams(); // This will now hide the completed exam
    }, 2500);

  } catch (err) {
    console.error("Submit error:", err);
    showPopup("FAILED", err.message || "Submission failed. Try again.");
  }
}

/* ... rest of your code (handleExit, confirmExit, showPopup, etc.) ... */
</script>
</body>
</html>
