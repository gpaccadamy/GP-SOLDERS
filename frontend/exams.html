<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Exam Portal</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); margin: 0; padding: 0; color: #333; }
    header { background: rgba(0,0,0,0.8); color: white; padding: 20px; text-align: center; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    header h1 { font-size: 26px; }
    .main { margin-top: 90px; padding: 20px; max-width: 900px; margin-left: auto; margin-right: auto; }
    .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .exam-list { display: flex; flex-direction: column; gap: 20px; }
    .exam-card { background: #f8f9fa; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
    .exam-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .exam-card.active { border-color: #4CAF50; background: #e8f5e8; }
    .question { margin-bottom: 40px; padding: 20px; background: #f8f9fa; border-radius: 12px; }
    .question img { max-width: 100%; border-radius: 10px; margin: 15px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .options { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    .option { display: flex; align-items: center; font-size: 18px; padding: 12px; background: white; border-radius: 10px; border: 2px solid #ddd; cursor: pointer; transition: 0.3s; }
    .option:hover { border-color: #667eea; }
    .option input { margin-right: 15px; transform: scale(1.3); }
    .submit-btn, .login-btn { background: #4CAF50; color: white; padding: 16px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; width: 100%; margin-top: 30px; }
    .submit-btn:hover, .login-btn:hover { background: #45a049; }
    .hidden { display: none; }
    .timer { font-size: 20px; text-align: center; color: #d32f2f; font-weight: bold; margin-bottom: 20px; }
    input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Student Exam Portal</h1>
  </header>
  <div class="main">
    <!-- Login Section -->
    <div id="loginSection" class="card">
      <h2 style="text-align:center;">Student Login</h2>
      <input type="text" id="mobile" placeholder="Enter your Mobile Number" required>
      <input type="password" id="password" placeholder="Enter your Password" required>
      <button class="login-btn" onclick="login()">Login</button>
      <p id="loginError" style="color:red; text-align:center; display:none;"></p>
    </div>

    <!-- Available Exams List (Hidden until login) -->
    <div id="examList" class="card hidden">
      <h2 style="text-align:center; color:#333;">Available Exams</h2>
      <div id="examsContainer" class="exam-list">
        <p style="text-align:center;">Loading exams...</p>
      </div>
    </div>

    <!-- Exam Taking Section (Hidden initially) -->
    <div id="examTaking" class="card hidden">
      <h2 id="examTitleDisplay" style="text-align:center;"></h2>
      <div class="timer" id="timer">Time Remaining: --</div>
      <form id="examForm">
        <div id="questionsContainer"></div>
        <button type="submit" class="submit-btn">Submit Exam</button>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "https://academy-backend-e02j.onrender.com";
    let currentExam = null;
    let studentAnswers = [];
    let loggedInStudent = null; // Will store student data after login

    // Login function
    async function login() {
      const mobile = document.getElementById('mobile').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');

      if (!mobile || !password) {
        errorEl.textContent = "Please enter mobile and password.";
        errorEl.style.display = 'block';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/student-login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mobile, password })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || "Login failed");
        }

        const student = await res.json();
        loggedInStudent = student;
        errorEl.style.display = 'none';
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('examList').classList.remove('hidden');
        loadAvailableExams();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
      }
    }

    async function loadAvailableExams() {
      try {
        const res = await fetch(`${API_URL}/active-exams`);
        const exams = await res.json();
        const container = document.getElementById('examsContainer');
        if (exams.length === 0) {
          container.innerHTML = "<p>No active exams right now. Please check later.</p>";
          return;
        }
        container.innerHTML = exams.map(exam => `
          <div class="exam-card" onclick="startExam('${exam._id}')">
            <h3>${exam.title}</h3>
            <p><strong>${exam.subject.toUpperCase()} - Class ${exam.classNum}</strong></p>
            <p>${exam.questions.length} Questions</p>
            <p style="color:#4CAF50; font-weight:bold;">Click to Start</p>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('examsContainer').innerHTML = "<p>Error loading exams. Try again later.</p>";
      }
    }

    async function startExam(examId) {
      try {
        const res = await fetch(`${API_URL}/exam/${examId}`);
        const exam = await res.json();
        currentExam = exam;
        studentAnswers = new Array(exam.questions.length).fill(null);
        document.getElementById('examList').classList.add('hidden');
        document.getElementById('examTaking').classList.remove('hidden');
        document.getElementById('examTitleDisplay').textContent = exam.title;
        const qContainer = document.getElementById('questionsContainer');
        qContainer.innerHTML = exam.questions.map((q, i) => `
          <div class="question">
            <h3>Question ${i + 1}</h3>
            <img src="${q.imageUrl}" alt="Question ${i+1}">
            <div class="options">
              <label class="option">
                <input type="radio" name="q${i}" value="a" onchange="saveAnswer(${i}, 'a')">
                <span>A</span>
              </label>
              <label class="option">
                <input type="radio" name="q${i}" value="b" onchange="saveAnswer(${i}, 'b')">
                <span>B</span>
              </label>
              <label class="option">
                <input type="radio" name="q${i}" value="c" onchange="saveAnswer(${i}, 'c')">
                <span>C</span>
              </label>
              <label class="option">
                <input type="radio" name="q${i}" value="d" onchange="saveAnswer(${i}, 'd')">
                <span>D</span>
              </label>
            </div>
          </div>
        `).join('');
        startTimer(60 * 30); // 30 minutes
      } catch (err) {
        alert("Error loading exam: " + err.message);
      }
    }

    function saveAnswer(questionIndex, answer) {
      studentAnswers[questionIndex] = answer;
    }

    function startTimer(minutes) {
      let seconds = minutes * 60;
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        seconds--;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timerEl.textContent = `Time Remaining: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
        if (seconds <= 0) {
          clearInterval(interval);
          alert("Time's up!");
          document.getElementById('examForm').dispatchEvent(new Event('submit'));
        }
      }, 1000);
    }

    document.getElementById('examForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (studentAnswers.some(a => a === null)) {
        if (!confirm("You haven't answered all questions. Submit anyway?")) return;
      }
      try {
        const res = await fetch(`${API_URL}/submit-exam`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            examId: currentExam._id,
            studentMobile: loggedInStudent.mobile,
            studentName: loggedInStudent.name,
            answers: studentAnswers
          })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || "Submission failed");
        }

        const result = await res.json();
        alert(result.message || "Exam submitted successfully!");
        document.getElementById('examTaking').classList.add('hidden');
        document.getElementById('examList').classList.remove('hidden');
        loadAvailableExams();
      } catch (err) {
        alert("Error submitting exam: " + err.message);
      }
    });

    // Load login first
    document.getElementById('loginSection').classList.remove('hidden');
  </script>
</body>
</html>
