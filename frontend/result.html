<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Results - Select Test</title>
  <link rel="icon" href="data:,">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0; padding: 0; color: #333;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 18px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    .logo {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 52px;
      height: 52px;
      border-radius: 50%;
      overflow: hidden;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .header-title {
      margin-left: 70px;
      font-size: 1.3rem;
    }
    .main { margin-top: 90px; padding: 20px; max-width: 900px; margin-left: auto; margin-right: auto; }
    .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #333; margin-bottom: 20px; }

    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    select, button {
      padding: 14px 18px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: white;
    }
    select { min-width: 200px; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    button:hover { background: #1d4ed8; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 14px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #667eea; color: white; }
    tr:hover { background: #f8f9fa; }
    .total-students { text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0; color: #1e293b; }
    .exam-info { text-align: center; font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 10px; }
    .no-results { text-align: center; color: #d32f2f; font-size: 18px; padding: 40px; }
    .initial-msg { text-align: center; color: #64748b; font-size: 18px; padding: 40px; }
    .rank { font-weight: bold; color: #2563eb; }

    .share-btn {
      display: block;
      margin: 30px auto 10px;
      padding: 16px 32px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(37,211,102,0.4);
    }
    .share-btn:hover { background: #128C7E; }
    .share-btn:disabled { background: #999; cursor: not-allowed; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="gplogo.jpg" alt="GP Soldiers Logo">
    </div>
    <div class="header-title">Exam Results</div>
  </header>

  <div class="main">
    <div class="card">
      <h2>Select Exam to View Results</h2>

      <div class="filter-section">
        <select id="subjectSelect">
          <option value="">Select Subject</option>
          <option value="english">English</option>
          <option value="kannada">Kannada</option>
          <option value="gk">GK</option>
          <option value="maths">Maths</option>
        </select>

        <select id="testNumberSelect">
          <option value="">Select Test Number</option>
        </select>

        <button onclick="loadResults()">Show Results</button>
      </div>

      <div id="examInfo" class="exam-info" style="display:none;"></div>
      <div id="totalStudents" class="total-students"></div>

      <div id="resultsContainer">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Student Name</th>
              <th>Roll Number</th>
              <th>Mobile</th>
              <th>Score (Correct/Total)</th>
              <th>Submitted At</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="6" class="initial-msg">
                Please select a Subject and Test Number, then click "Show Results"
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button id="shareBtn" class="share-btn hidden" onclick="shareResults()">
        Share Results on WhatsApp
      </button>
    </div>
  </div>

  <script>
    const API_URL = "https://academy-backend-e02j.onrender.com";

    function populateTestNumbers() {
      const select = document.getElementById('testNumberSelect');
      select.innerHTML = '<option value="">Select Test Number</option>';
      for (let i = 1; i <= 50; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Test ${i}`;
        select.appendChild(opt);
      }
    }

    async function loadResults() {
      const subject = document.getElementById('subjectSelect').value;
      const testNumber = document.getElementById('testNumberSelect').value;

      if (!subject || !testNumber) {
        alert("Please select both Subject and Test Number");
        return;
      }

      const shareBtn = document.getElementById('shareBtn');
      shareBtn.classList.add('hidden');

      try {
        const res = await fetch(`${API_URL}/results`);
        if (!res.ok) throw new Error("Failed to fetch results");
        let results = await res.json();

        results = results.filter(r =>
          r.examSubject?.toLowerCase() === subject &&
          r.examTestNumber == parseInt(testNumber)
        );

        results.sort((a, b) => {
          if (b.correct !== a.correct) return b.correct - a.correct;
          return new Date(a.submittedAt) - new Date(b.submittedAt);
        });

        const tbody = document.getElementById('resultsBody');
        const totalEl = document.getElementById('totalStudents');
        const examInfoEl = document.getElementById('examInfo');

        const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
        examInfoEl.textContent = `${subjectName} - Test ${testNumber}`;
        examInfoEl.style.display = 'block';

        if (results.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="no-results">No students have attempted this exam yet.</td></tr>';
          totalEl.textContent = '';
          return;
        }

        totalEl.textContent = `Total Students Attempted: ${results.length}`;
        shareBtn.classList.remove('hidden');

        tbody.innerHTML = results.map((r, index) => `
          <tr>
            <td class="rank">#${index + 1}</td>
            <td>${r.studentName}</td>
            <td>${r.studentRoll || 'N/A'}</td>
            <td>${r.studentMobile}</td>
            <td><strong>${r.correct} / ${r.total}</strong></td>
            <td>${new Date(r.submittedAt).toLocaleString()}</td>
          </tr>
        `).join('');

      } catch (err) {
        document.getElementById('resultsBody').innerHTML =
          `<tr><td colspan="6" class="no-results">Error: ${err.message}</td></tr>`;
      }
    }

    async function shareResults() {
      const container = document.getElementById('resultsContainer');
      const shareBtn = document.getElementById('shareBtn');
      shareBtn.disabled = true;
      shareBtn.textContent = "Generating image...";

      try {
        const canvas = await html2canvas(container, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });

        canvas.toBlob(async (blob) => {
          const file = new File([blob], 'gp-soldiers-results.png', { type: 'image/png' });

          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              files: [file],
              title: 'GP Soldiers Academy - Exam Results',
              text: 'Check out the latest exam results!'
            });
          } else {
            // Fallback: Download image
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gp-soldiers-results.png';
            a.click();
            alert("Image downloaded! You can now share it manually on WhatsApp.");
          }

          shareBtn.disabled = false;
          shareBtn.textContent = "Share Results on WhatsApp";
        }, 'image/png');
      } catch (err) {
        alert("Failed to generate image. Try again.");
        shareBtn.disabled = false;
        shareBtn.textContent = "Share Results on WhatsApp";
      }
    }

    populateTestNumbers();
  </script>
</body>
</html>
