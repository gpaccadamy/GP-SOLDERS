<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <title>Admin - Bulk Paste & Edit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Tiro+Kannada&display=swap'); .kn { font-family: 'Tiro Kannada', serif; }</style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white p-8 rounded-3xl shadow-xl mb-6">
            <h1 class="text-3xl font-bold mb-4">Paste & Split Exam Maker</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="title" placeholder="Exam Title" class="border p-4 rounded-xl outline-none">
                <input type="text" id="subject" placeholder="Subject" class="border p-4 rounded-xl outline-none">
                <input type="number" id="testNumber" placeholder="Test Number" class="border p-4 rounded-xl outline-none">
            </div>

            <textarea id="rawInput" rows="10" class="w-full border-2 border-dashed p-4 rounded-2xl kn mb-4" 
                placeholder="Paste full text here... e.g. 1. Question... A) Option B) Option..."></textarea>
            
            <button onclick="splitQuestions()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700">
                Split Questions Below ðŸ‘‡
            </button>
        </div>

        <div id="edit-area" class="hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Review & Edit Questions:</h2>
            <div id="questions-list" class="space-y-4"></div>
            
            <button onclick="saveToMongo()" class="mt-10 w-full bg-green-600 text-white py-5 rounded-2xl font-black text-2xl shadow-lg">
                SAVE ALL TO MONGODB
            </button>
        </div>
    </div>

    <script>
        let questionData = [];

        function splitQuestions() {
            const text = document.getElementById('rawInput').value;
            // Split by number patterns like 1. or 2.
            const blocks = text.split(/\n\s*(\d+)[\.\)\-]\s+/).filter(b => b.trim().length > 5);
            
            questionData = [];
            const list = document.getElementById('questions-list');
            list.innerHTML = "";

            for (let i = 0; i < blocks.length; i++) {
                if (!isNaN(blocks[i])) {
                    const qNum = blocks[i];
                    const content = blocks[i+1] || "";
                    const lines = content.split('\n').map(l => l.trim()).filter(l => l);
                    
                    const qText = lines[0];
                    // Regex to find options like A), B) or Kannada variants
                    const optRegex = /^[A-D\u0CB0-\u0CB9\u0CDE-\u0CDF][\.\)\-]\s*/i;
                    const options = lines.filter(l => optRegex.test(l));

                    const qObj = { questionText: qText, options: options, correctAnswer: "" };
                    questionData.push(qObj);

                    const qCard = document.createElement('div');
                    qCard.className = "bg-white p-6 rounded-2xl shadow-md border-l-8 border-blue-500";
                    qCard.innerHTML = `
                        <div class="mb-2">
                            <span class="font-bold text-blue-600">Question ${qNum}:</span>
                            <textarea oninput="updateQ(${questionData.length-1}, this.value)" class="w-full kn p-2 border rounded-lg mt-1">${qText}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${qObj.options.map((opt, idx) => `
                                <input type="text" value="${opt}" class="border p-2 rounded kn text-sm" 
                                    oninput="updateOpt(${questionData.length-1}, ${idx}, this.value)">
                            `).join('')}
                        </div>
                        <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                            <span class="text-sm font-bold">Select Answer:</span>
                            ${['A','B','C','D'].map(l => `
                                <button onclick="setAns(${questionData.length-1}, '${l}', this)" 
                                    class="w-10 h-10 border-2 rounded-lg font-bold hover:bg-blue-500 hover:text-white transition">
                                    ${l}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    list.appendChild(qCard);
                    i++;
                }
            }
            document.getElementById('edit-area').classList.remove('hidden');
        }

        // Live Update Functions
        function updateQ(idx, val) { questionData[idx].questionText = val; }
        function updateOpt(qIdx, oIdx, val) { questionData[idx].options[oIdx] = val; }
        
        function setAns(qIdx, letter, btn) {
            questionData[qIdx].correctAnswer = letter;
            btn.parentElement.querySelectorAll('button').forEach(b => b.className = "w-10 h-10 border-2 rounded-lg font-bold");
            btn.className = "w-10 h-10 bg-blue-600 text-white rounded-lg font-bold";
        }

        async function saveToMongo() {
            const payload = {
                title: document.getElementById('title').value,
                subject: document.getElementById('subject').value,
                testNumber: document.getElementById('testNumber').value,
                questions: questionData
            };

            const res = await fetch('/api/save-bulk-exam', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("ðŸŽ‰ Successfully Saved to MongoDB Drafts!");
                window.location.reload();
            }
        }
    </script>
</body>
</html>
