<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mixed Paper Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tiro+Kannada&family=Poppins:wght@400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .kn-text { font-family: 'Tiro Kannada', serif; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <div class="bg-white p-8 rounded-3xl shadow-xl mb-10 border border-gray-100">
            <h1 class="text-2xl font-bold mb-4 text-blue-600">ðŸš€ AI Hybrid Parser (Mixed Lang)</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="title" placeholder="Exam Title" class="p-3 border rounded-xl">
                <input type="text" id="subject" placeholder="Subject" class="p-3 border rounded-xl">
                <input type="number" id="testNumber" placeholder="Test Number" class="p-3 border rounded-xl">
            </div>

            <textarea id="rawInput" rows="12" class="w-full p-5 border-2 border-dashed border-blue-200 rounded-2xl kn-text text-lg outline-none focus:border-blue-500 mb-4" 
                placeholder="Paste Question Paper Here...&#10;1. Question text?&#10;A) Opt 1&#10;B) Opt 2..."></textarea>
            
            <button onclick="smartParse()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">
                Parse Mixed Questions âœ¨
            </button>
        </div>

        <div id="previewSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Preview Questions (<span id="count">0</span>)</h2>
            </div>
            <div id="cardContainer" class="space-y-6"></div>

            <button onclick="saveToBackend()" class="w-full mt-10 bg-green-600 text-white py-6 rounded-3xl font-black text-2xl shadow-2xl hover:bg-green-700 transition-all">
                SAVE ALL TO MONGODB ðŸ’¾
            </button>
        </div>
    </div>

    <script>
        let parsedQuestions = [];

        function smartParse() {
            const raw = document.getElementById('rawInput').value;
            if(!raw.trim()) return alert("Please paste text!");

            // AI Logic: Splits by English (1-9) or Kannada (à³§-à³¯) numbers followed by . or )
            const blocks = raw.split(/\n\s*(\d+|[\u0CE6-\u0CEF]+)[\.\)\-]\s+/).filter(b => b.trim().length > 5);
            
            parsedQuestions = [];
            const container = document.getElementById('cardContainer');
            container.innerHTML = "";

            // Loop through blocks (skipping the number matches)
            for (let i = 0; i < blocks.length; i++) {
                if (blocks[i].match(/^(\d+|[\u0CE6-\u0CEF]+)$/)) {
                    const qNum = blocks[i];
                    const textContent = blocks[i+1] || "";
                    
                    const lines = textContent.split('\n').map(l => l.trim()).filter(l => l);
                    const qText = lines[0];

                    // Identify options (A-D or Kannada equivalent)
                    const optRegex = /^([A-D]|à²Ž|à²¬à²¿|à²¸à²¿|à²¡à²¿)[\.\)\-]\s*/i;
                    const options = lines.filter(l => optRegex.test(l));

                    const qObj = {
                        questionText: qText,
                        options: options.length >= 2 ? options : ["A) ", "B) ", "C) ", "D) "],
                        correctAnswer: ""
                    };

                    parsedQuestions.push(qObj);
                    renderQuestion(qObj, parsedQuestions.length - 1, qNum);
                    i++; 
                }
            }

            if(parsedQuestions.length === 0) {
                alert("Could not parse. Make sure questions start with 1. or à³§.");
            } else {
                document.getElementById('count').innerText = parsedQuestions.length;
                document.getElementById('previewSection').classList.remove('hidden');
            }
        }

        function renderQuestion(q, idx, num) {
            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-3xl shadow-sm border border-gray-200";
            div.innerHTML = `
                <div class="flex gap-4">
                    <span class="bg-blue-100 text-blue-700 w-10 h-10 flex items-center justify-center rounded-full font-bold">${num}</span>
                    <div class="flex-grow">
                        <h3 class="kn-text text-lg font-semibold mb-4">${q.questionText}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            ${q.options.map(opt => `<div class="kn-text p-3 bg-gray-50 border rounded-xl text-sm">${opt}</div>`).join('')}
                        </div>
                        <div class="flex gap-2">
                            ${['A', 'B', 'C', 'D'].map(val => `
                                <button onclick="setCorrect(${idx}, '${val}', this)" class="btn-${idx} px-4 py-2 border rounded-lg font-bold hover:bg-gray-100">${val}</button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('cardContainer').appendChild(div);
        }

        function setCorrect(idx, val, btn) {
            parsedQuestions[idx].correctAnswer = val;
            document.querySelectorAll(`.btn-${idx}`).forEach(b => b.className = `btn-${idx} px-4 py-2 border rounded-lg font-bold hover:bg-gray-100`);
            btn.className = `btn-${idx} px-4 py-2 bg-blue-600 text-white rounded-lg font-bold`;
        }

        async function saveToBackend() {
            const payload = {
                title: document.getElementById('title').value,
                subject: document.getElementById('subject').value,
                testNumber: document.getElementById('testNumber').value,
                questions: parsedQuestions
            };

            if(parsedQuestions.some(q => !q.correctAnswer)) return alert("Select correct answers for all!");

            try {
                const res = await fetch('/api/save-bulk-exam', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success) { alert("Exam Saved Successfully!"); window.location.reload(); }
            } catch(e) { alert("Server Error!"); }
        }
    </script>
</body>
</html>
