<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <title>AI Hybrid Parser (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tiro+Kannada&family=Poppins:wght@400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; }
        .kn-text { font-family: 'Tiro Kannada', serif; line-height: 1.6; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
        <h1 class="text-2xl font-bold text-blue-700 mb-6 flex items-center gap-2">
            üõ°Ô∏è AI Question Splitter (Anti-Error Mode)
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
            <input type="text" id="title" placeholder="Exam Title" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <input type="text" id="subject" placeholder="Subject" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <input type="number" id="testNumber" placeholder="Test No." class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
        </div>

        <textarea id="rawInput" rows="12" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-2xl kn-text text-lg mb-4 focus:border-blue-500 outline-none" 
            placeholder="Paste here. Even with new lines after numbers..."></textarea>
        
        <button onclick="superAIParse()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-xl hover:bg-blue-700 shadow-lg transition-all">
            Parse Mixed Questions Now üöÄ
        </button>

        <div id="previewArea" class="mt-10 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Review Extracted Questions (<span id="count">0</span>)</h2>
            <div id="cardContainer" class="space-y-6"></div>
            <button onclick="saveToMongo()" class="w-full mt-10 bg-green-600 text-white py-5 rounded-2xl font-black text-2xl shadow-xl hover:bg-green-700 transition-all">
                SAVE TO DATABASE üíæ
            </button>
        </div>
    </div>

    <script>
        let parsedQuestions = [];

        function superAIParse() {
            const rawText = document.getElementById('rawInput').value.trim();
            if (!rawText) return alert("Please paste text!");

            // IMPROVED REGEX: Splits by English/Kannada numbers even if followed by newlines
            // It looks for Number followed by . or ) and any amount of whitespace
            const sections = rawText.split(/\n?\s*(?:\d+|[\u0CE6-\u0CEF]+)[\.\)\-]\s*/);
            
            // The first element is usually empty or intro text
            const questionContents = sections.filter(s => s.trim().length > 10);
            
            parsedQuestions = [];
            const container = document.getElementById('cardContainer');
            container.innerHTML = "";

            questionContents.forEach((content, index) => {
                const lines = content.split('\n').map(l => l.trim()).filter(l => l);
                
                // Smart Option Detection: A), B), C), D) or 1), 2), 3), 4) or ‡≤é), ‡≤¨‡≤ø)
                const optRegex = /^([A-D]|‡≤é|‡≤¨‡≤ø|‡≤∏‡≤ø|‡≤°‡≤ø|[1-4]|‡≥ß|‡≥®|‡≥©|‡≥™)[\.\)\-]\s*/i;
                
                // Separate Question Text from Options
                const options = lines.filter(l => optRegex.test(l));
                const questionTextLines = lines.filter(l => !optRegex.test(l));
                const questionText = questionTextLines.join(' ');

                const qObj = {
                    questionText,
                    options: options.length >= 2 ? options : ["Option A", "Option B", "Option C", "Option D"],
                    correctAnswer: ""
                };

                parsedQuestions.push(qObj);
                renderCard(qObj, index);
            });

            if (parsedQuestions.length > 0) {
                document.getElementById('count').innerText = parsedQuestions.length;
                document.getElementById('previewArea').classList.remove('hidden');
                window.scrollTo({ top: document.getElementById('previewArea').offsetTop, behavior: 'smooth' });
            } else {
                alert("AI couldn't find questions. Try to ensure each question starts with a number like 1. or 2.");
            }
        }

        function renderCard(q, idx) {
            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-2xl shadow-md border-l-8 border-blue-500";
            div.innerHTML = `
                <div class="kn-text font-bold text-gray-800 text-lg mb-4">${idx + 1}. ${q.questionText}</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    ${q.options.map(opt => `<div class="kn-text p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm">${opt}</div>`).join('')}
                </div>
                <div class="flex gap-2 items-center">
                    <span class="text-xs font-bold text-gray-400 mr-2 uppercase">Correct:</span>
                    ${['A', 'B', 'C', 'D'].map(val => `
                        <button onclick="setCorrect(${idx}, '${val}', this)" 
                            class="ans-btn-${idx} w-10 h-10 border-2 rounded-lg font-bold transition-all">
                            ${val}
                        </button>
                    `).join('')}
                </div>
            `;
            document.getElementById('cardContainer').appendChild(div);
        }

        function setCorrect(qIdx, val, btn) {
            parsedQuestions[qIdx].correctAnswer = val;
            document.querySelectorAll(`.ans-btn-${qIdx}`).forEach(b => {
                b.className = `ans-btn-${qIdx} w-10 h-10 border-2 rounded-lg font-bold bg-white text-gray-500`;
            });
            btn.className = `ans-btn-${qIdx} w-10 h-10 bg-blue-600 text-white rounded-lg font-bold border-blue-600 scale-110`;
        }

        async function saveToMongo() {
            const title = document.getElementById('title').value;
            if (!title) return alert("Enter Exam Title");
            if (parsedQuestions.some(q => !q.correctAnswer)) return alert("Select answers for ALL questions");

            const payload = {
                title,
                subject: document.getElementById('subject').value || "Mixed",
                testNumber: document.getElementById('testNumber').value || 1,
                questions: parsedQuestions
            };

            try {
                const res = await fetch('/api/save-bulk-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alert("üéâ Success! Saved to MongoDB.");
                    window.location.reload();
                }
            } catch (err) { alert("Server connection failed"); }
        }
    </script>
</body>
</html>
