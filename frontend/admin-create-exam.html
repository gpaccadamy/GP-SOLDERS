<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <title>Admin - Create Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Tiro+Kannada&display=swap'); .kn { font-family: 'Tiro Kannada', serif; }</style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-5xl mx-auto bg-white p-8 rounded-3xl shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-4">Bulk Exam Creator (Copy-Paste)</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <input type="text" id="title" placeholder="Exam Title" class="border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <input type="text" id="subject" placeholder="Subject" class="border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <input type="number" id="testNumber" placeholder="Test No" class="border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
        </div>

        <div class="mb-6">
            <label class="block font-bold mb-2 text-gray-600">Paste Question Paper Content Here:</label>
            <textarea id="rawInput" rows="10" class="w-full border-2 border-dashed border-gray-300 p-4 rounded-2xl kn outline-none focus:border-blue-500" placeholder="1. Question text... A) Option B) Option..."></textarea>
        </div>

        <button onclick="processText()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition">
            Process & Separate Questions
        </button>

        <div id="review-section" class="hidden mt-10">
            <h2 class="text-2xl font-bold text-orange-600 mb-6">Step 2: Review & Set Correct Answers</h2>
            <div id="questions-list" class="space-y-6"></div>
            <button onclick="saveBulk()" class="mt-10 w-full bg-green-600 text-white py-5 rounded-2xl font-bold text-2xl shadow-lg hover:bg-green-700 transition">
                Publish to Drafts
            </button>
        </div>
    </div>

    <script>
        let extractedQuestions = [];

        function processText() {
            const text = document.getElementById('rawInput').value;
            if (!text.trim()) return alert("Please paste some text first!");

            // Regex: Finds numbers followed by . or ) including Kannada support
            const blocks = text.split(/\n\s*(\d+)[\.\)\-]\s+/).filter(b => b.trim().length > 5);
            
            extractedQuestions = [];
            const list = document.getElementById('questions-list');
            list.innerHTML = "";

            for (let i = 0; i < blocks.length; i++) {
                if (!isNaN(blocks[i])) {
                    const number = blocks[i];
                    const content = blocks[i+1] || "";
                    const lines = content.split('\n').map(l => l.trim()).filter(l => l);
                    
                    const qText = lines[0];
                    // Detect options A) B) C) D) or Kannada ໖) ໖)
                    const optRegex = /^[A-D\u0CB0-\u0CB9\u0CDE-\u0CDF][\.\)\-]\s*/i;
                    const options = lines.filter(l => optRegex.test(l));

                    extractedQuestions.push({
                        questionText: qText,
                        options: options.length >= 2 ? options : ["A) ", "B) ", "C) ", "D) "],
                        correctAnswer: null
                    });

                    const qDiv = document.createElement('div');
                    qDiv.className = "bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm";
                    qDiv.innerHTML = `
                        <p class="font-bold text-lg mb-3 kn">${number}. ${qText}</p>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4 kn">
                            ${options.map(o => `<span>${o}</span>`).join('')}
                        </div>
                        <div class="flex gap-2">
                            ${['A','B','C','D'].map(ans => `
                                <button onclick="setAns(${extractedQuestions.length-1}, '${ans}', this)" 
                                    class="px-4 py-2 border rounded-lg bg-white text-blue-600 font-bold hover:bg-blue-600 hover:text-white transition">
                                    Set ${ans}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    list.appendChild(qDiv);
                    i++;
                }
            }
            document.getElementById('review-section').classList.remove('hidden');
        }

        function setAns(qIdx, ans, btn) {
            extractedQuestions[qIdx].correctAnswer = ans;
            btn.parentElement.querySelectorAll('button').forEach(b => b.className = "px-4 py-2 border rounded-lg bg-white text-blue-600 font-bold");
            btn.className = "px-4 py-2 border rounded-lg bg-blue-600 text-white font-bold shadow-md";
        }

        async function saveBulk() {
            const data = {
                title: document.getElementById('title').value,
                subject: document.getElementById('subject').value,
                testNumber: document.getElementById('testNumber').value,
                questions: extractedQuestions
            };

            if (!data.title || extractedQuestions.some(q => !q.correctAnswer)) {
                return alert("Please enter title and select answers for ALL questions!");
            }

            const res = await fetch('/api/save-bulk-exam', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert("Saved to Drafts! You can now make it live from your Admin Dashboard.");
                window.location.reload();
            }
        }
    </script>
</body>
</html>
